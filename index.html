<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>冬日列车</title>

  <style>
    :root{
      --bg0:#070a14;
      --bg1:#0b1020;
      --txt:#eef0ff;
      --mut:rgba(238,240,255,.72);
      --mut2:rgba(238,240,255,.55);
      --good:#6be7a8;
      --warn:#ffd36b;
      --bad:#ff6b8a;
      --shadow: 0 22px 78px rgba(0,0,0,.52);
      --shadow2: 0 10px 34px rgba(0,0,0,.35);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC","Noto Sans SC", Arial, "Microsoft YaHei", sans-serif;
      color:var(--txt);
      overflow:hidden;
      background:
        radial-gradient(1200px 800px at 18% 12%, rgba(96, 122, 255, .33) 0%, rgba(12, 18, 44, 0) 56%),
        radial-gradient(900px 600px at 78% 22%, rgba(255, 211, 107, .16) 0%, rgba(12, 18, 44, 0) 62%),
        radial-gradient(1100px 700px at 50% 100%, rgba(107,231,168,.10) 0%, rgba(12, 18, 44, 0) 62%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 60%, #060812 100%);
    }

    /* 雪花（纯CSS） */
    .snow, .snow:before, .snow:after{
      position:fixed; inset:-200px 0 0 0; content:"";
      pointer-events:none;
      background-image:
        radial-gradient(2px 2px at 10% 10%, rgba(255,255,255,.60) 40%, rgba(255,255,255,0) 42%),
        radial-gradient(1px 1px at 40% 30%, rgba(255,255,255,.55) 45%, rgba(255,255,255,0) 47%),
        radial-gradient(2px 2px at 70% 20%, rgba(255,255,255,.50) 40%, rgba(255,255,255,0) 42%),
        radial-gradient(1px 1px at 90% 60%, rgba(255,255,255,.45) 45%, rgba(255,255,255,0) 47%),
        radial-gradient(2px 2px at 25% 80%, rgba(255,255,255,.40) 40%, rgba(255,255,255,0) 42%),
        radial-gradient(1px 1px at 55% 75%, rgba(255,255,255,.48) 45%, rgba(255,255,255,0) 47%),
        radial-gradient(2px 2px at 80% 88%, rgba(255,255,255,.38) 40%, rgba(255,255,255,0) 42%);
      background-size: 460px 460px;
      opacity:.26;
      filter: blur(.2px);
      animation: snowFall 20s linear infinite;
    }
    .snow:before{
      opacity:.16; background-size: 640px 640px;
      animation-duration: 28s; transform: translateY(-140px);
    }
    .snow:after{
      opacity:.12; background-size: 820px 820px;
      animation-duration: 36s; transform: translateY(-240px);
      filter: blur(.6px);
    }
    @keyframes snowFall{0%{transform: translateY(-260px)}100%{transform: translateY(980px)}}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .wrap{min-height:100vh; display:flex; flex-direction:column;}

    /* 顶栏 */
    .top{
      padding:16px 16px 14px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border-bottom: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 8px 28px rgba(0,0,0,.30);
    }
    .title{
      font-size:22px; font-weight:1000; letter-spacing:.6px;
      display:flex; align-items:center; gap:10px;
    }
    .title:before{
      content:""; width:10px; height:10px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,211,107,.50), rgba(107,231,168,.20));
      box-shadow: 0 0 18px rgba(255,211,107,.35);
    }
    .sub{font-size:12px; color:var(--mut); line-height:1.7;}

    .pill{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:9px 12px; border-radius:999px; font-size:12px; color:rgba(238,240,255,.90);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
      user-select:none;
    }
    .pill b{color:var(--txt)}
    .pill.btn{cursor:pointer; transition: transform .08s ease, background .12s ease;}
    .pill.btn:active{transform: scale(.98);}

    /* 舞台 */
    .main{flex:1; display:flex; align-items:center; justify-content:center; padding:14px;}
    .stage{
      width:min(980px, 96vw);
      border-radius: calc(var(--radius) + 10px);
      padding:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.085), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .row{
      border-radius: var(--radius);
      padding:14px 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      margin-bottom:12px;
    }

    /* 大字幕 */
    #cardTitle{
      font-size: clamp(26px, 6.2vw, 44px);
      font-weight: 1200;
      letter-spacing: .6px;
      line-height:1.12;
    }
    #cardBody{
      margin-top:10px;
      font-size: clamp(16px, 4.6vw, 26px);
      color: rgba(238,240,255,.94);
      line-height:1.62;
      white-space: pre-line;
    }

    .metaLine{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
      color: var(--mut);
      font-size:12px;
    }
    .metaTag{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(238,240,255,.86);
    }
    .metaTag b{color:rgba(238,240,255,.95)}

    /* 控制区：普通/隐藏/补给/许愿（手机点击） */
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .ctrlBtn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
      color: var(--txt);
      padding:14px 12px;
      border-radius: 18px;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      transition: transform .08s ease, background .12s ease;
    }
    .ctrlBtn:active{transform: scale(.99);}
    .ctrlBtn.alt{font-weight:800; font-size:15px; color:rgba(238,240,255,.92);}

    /* 岔路按钮：出现时显示 */
    .branchBar{display:none; margin-top:10px;}
    .branchBar.show{display:grid;}
    .branchBar{
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .branchBtn{
      padding:14px 0;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(238,240,255,.96);
      font-size:20px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      transition: transform .08s ease, background .12s ease;
    }
    .branchBtn:active{transform: scale(.99);}

    /* Toast */
    .toast{
      position:fixed; left:50%; top:10%;
      transform: translateX(-50%) scale(.98);
      min-width: min(980px, 96vw);
      padding:16px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(10,14,34,.80);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      z-index:9999;
      opacity:0;
      pointer-events:none;
      white-space:pre-line;
    }
    .toast.show{animation: pop 2.8s ease forwards;}
    @keyframes pop{
      0%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.96);}
      12%{opacity:1; transform:translateX(-50%) translateY(0px) scale(1);}
      82%{opacity:1; transform:translateX(-50%) translateY(0px) scale(1);}
      100%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.98);}
    }
    .toast .t1{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .toast .tt{font-size:18px; font-weight:1100;}
    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--mut);
      font-size:12px;
      white-space:nowrap;
    }
    .badge.good{border-color: rgba(107,231,168,.35); background: rgba(107,231,168,.12); color: rgba(238,240,255,.92);}
    .badge.warn{border-color: rgba(255,211,107,.35); background: rgba(255,211,107,.12); color: rgba(238,240,255,.92);}
    .badge.bad{border-color: rgba(255,107,138,.35); background: rgba(255,107,138,.12); color: rgba(238,240,255,.92);}
    .toast .msg{margin-top:10px; font-size:16px; color: rgba(238,240,255,.94); line-height:1.6;}

    /* 站台灯大字（可保留） */
    .lamp{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:10000;
      background:
        radial-gradient(900px 500px at 50% 35%, rgba(255,211,107,.26) 0%, rgba(0,0,0,0) 60%),
        rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .lamp.show{display:flex; animation: lampPop 1.65s ease forwards;}
    @keyframes lampPop{
      0%{opacity:0; transform: scale(.98)}
      12%{opacity:1; transform: scale(1)}
      78%{opacity:1; transform: scale(1)}
      100%{opacity:0; transform: scale(.99)}
    }
    .lampCard{
      width:min(980px, 92vw);
      border-radius: 28px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(10,14,34,.86);
      box-shadow: var(--shadow);
      padding:20px;
    }
    .lampTitle{
      font-size: clamp(34px, 7vw, 56px);
      font-weight: 1250;
      letter-spacing: 1px;
      line-height: 1.05;
    }
    .lampSub{
      margin-top:10px;
      font-size: clamp(16px, 4.8vw, 26px);
      color: rgba(238,240,255,.94);
      line-height:1.55;
      white-space:pre-line;
    }
  </style>
</head>

<body>
  <div class="snow" aria-hidden="true"></div>

  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">2026冬日列车</div>
        <div class="sub mono">手机点：普通/隐藏=直接结算｜补给=强制下一单加拆｜许愿=写入剧情</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <div id="btnWish" class="pill btn">许愿</div>
        <div id="btnSupply" class="pill btn">补给</div>
      </div>
    </div>

    <div class="main">
      <div class="stage">
        <div class="row">
          <div style="font-size:14px; color:rgba(238,240,255,.92); font-weight:900;">舞台字幕</div>
          <div class="metaLine">
            <span class="metaTag"><b id="actTag">幕一 · 起程</b></span>
            <span class="metaTag">许愿：<b id="wishTag">未写入</b></span>
            <span class="metaTag">最后播报：<b id="lastEvt">-</b></span>
          </div>
        </div>

        <div class="row">
          <div id="cardTitle">结果卡：等待结算</div>
          <div id="cardBody">点击「普通」或「隐藏」即可结算本单。</div>

          <!-- 岔路按钮区：只有岔路出现才显示 -->
          <div class="branchBar" id="branchBar">
            <div class="branchBtn" id="btnA">A</div>
            <div class="branchBtn" id="btnB">B</div>
            <div class="branchBtn" id="btnC">C</div>
          </div>
        </div>

        <div class="row">
          <div class="controls">
            <button class="ctrlBtn" id="btnO">普通</button>
            <button class="ctrlBtn" id="btnH">隐藏</button>
            <button class="ctrlBtn alt" id="btnReset" style="grid-column:1/3;">重置</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="t1">
      <div class="tt" id="toastTitle">提示</div>
      <div class="badge warn" id="toastBadge">事件</div>
    </div>
    <div class="msg" id="toastMsg">内容</div>
  </div>

  <!-- 站台灯 -->
  <div class="lamp" id="lamp">
    <div class="lampCard">
      <div class="lampTitle" id="lampTitle">站台灯亮起</div>
      <div class="lampSub" id="lampSub">回礼车厢开启</div>
    </div>
  </div>

<script>
/* =========================
   配置
========================= */
const CFG = {
  common: 519,
  hidden: 11,
  scarf: 12,
  doll: 3,

  branchEvery: 3,
  hiddenAddStreak: 3,

  cAddTotal: 30,
  cUnlockPerB: 1,

  // 三幕主线（每30单推进一幕）
  actStep: 30,
  acts: [
    { name: "幕一 · 起程", cue: "暖灯亮起，风铃响了——列车正式出发。" },
    { name: "幕二 · 暴雪", cue: "窗外暴雪加剧——隐藏车厢与补给开始紧张。" },
    { name: "幕三 · 回家", cue: "远处出现熟悉的灯火——我们正在靠近‘家’。" }
  ],

  // 大礼物解锁节奏（内部队列，不对观众展示库存）
  giftUnlockOrders: [15, 30, 45, 62, 80, 98, 120, 142, 166, 192, 220, 248, 278, 310, 345],
  giftSequence: [
    "围巾","围巾","玲娜贝尔",
    "围巾","围巾","围巾","玲娜贝尔",
    "围巾","围巾","围巾","玲娜贝尔",
    "围巾","围巾","围巾","围巾"
  ],

  finalAnnouncement:
`各位乘客我们的终点站 —— 家 已经到达
请各位收拾好自己的盒子并检查和确认是否有疑问
如有疑问请联系客服为您检查`
};

/* =========================
   文案池
========================= */
const TEXT = {
  base: [
    "列车广播轻响：雪夜在窗外慢慢铺开",
    "车厢灯带亮起：空气里多了一点暖",
    "站台风铃一响：冬天的故事开始推进",
    "玻璃起雾又散：像有人悄悄在守护"
  ],
  hidden: [
    "隐藏车厢被点亮：霜面裂开一道光",
    "站牌翻面：出现一张隐藏车票",
    "铃声轻响：隐藏纪念章落在掌心",
    "车门合上又开：雪景短暂露面"
  ],
  add: [
    "补给车厢接驳：随行礼已装载",
    "暖风机启动：多一份安心被递上",
    "补给箱弹开：额外守护已到账",
    "列车员点头：加挂一节暖车厢"
  ],
  branchA: [
    "岔路转向：车厢里响起轻快旋律",
    "你按下按钮：仪表盘亮起温柔提示",
    "车门一开一合：落下一张回礼卡",
    "灯带变色：弹幕瞬间沸腾"
  ],
  branchB: [
    "转轨成功：引擎低鸣、速度悄悄上来",
    "列车加速：前方车厢出现新灯号",
    "轨道切换：一段新剧情被点亮",
    "提示音响：路线确认、故事推进"
  ],
  branchC: [
    "补给信号闪烁：连接通道开启",
    "接驳完成：后方多出一节小车厢",
    "仪表盘闪了一下：补给已就位",
    "车厢尽头亮灯：补给车靠站"
  ],
  upgrade: [
    "系统提示：补给已满载，回礼升级为纪念款",
    "车厢提示：改为升级回礼（更精致更稀有）",
    "提示音落下：升级回礼已入袋",
    "暖光聚焦：升级回礼作为通关印记"
  ],
  scarf: [
    "围炉小站亮灯：冬日围巾悄悄系上",
    "北风被挡在门外：围巾到位",
    "暖光从车门涌出：围巾作为通关礼",
    "雪花落在肩头：围巾刚好接住"
  ],
  doll: [
    "车厢尽头出现玩偶座：玲娜贝尓入座",
    "小铃铛摇响：玲娜贝尔被送上车",
    "暖灯聚焦：玲娜贝尔成为今晚主角",
    "列车长微笑点头：玲娜贝尔到站"
  ],
  bigGiftCue: [
    "列车提示：B方向车厢亮起金色灯号",
    "广播低声提醒：B方向即将开启补给",
    "车门处出现暖光：B方向似乎更近了",
    "站台灯牌闪烁：B方向正在呼叫"
  ]
};

/* =========================
   工具：洗牌抽文案
========================= */
function shuffle(a){
  a=a.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
const DECK = {}, IDX = {};
function initDecks(){
  for(const k of Object.keys(TEXT)){
    DECK[k]=shuffle(TEXT[k]);
    IDX[k]=0;
  }
}
function pick(k){
  const d=DECK[k]||["…"];
  const i=IDX[k]||0;
  IDX[k]=i+1;
  return d[i % d.length];
}

/* =========================
   状态
========================= */
const S = {
  ended: false,

  commonLeft: CFG.common,
  hiddenLeft: CFG.hidden,
  scarfLeft: CFG.scarf,
  dollLeft: CFG.doll,

  addStreak: 0,
  ordersInternal: 0,

  cTotal: CFG.cAddTotal,
  cUnlocked: 0,
  cUsed: 0,
  cBuffForNext: false,

  giftUnlockIdx: 0,
  pendingGifts: [],

  // 站台灯：由B解锁，下一次任意岔路揭晓一次大礼物
  stationLight: 0,

  // 三幕主线
  act: 1,

  // 许愿词
  wishText: "未写入",
  wishPendingOnce: false,

  // 强制下一单加拆（隐形）
  forceAddNext: false,

  // 岔路状态：出现时才允许点A/B/C
  branchPending: false,
};

const $ = (id)=>document.getElementById(id);
const toast = $("toast");
const lamp = $("lamp");
const branchBar = $("branchBar");

/* =========================
   UI
========================= */
function stamp(){
  const t=new Date();
  return t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
}
function showToast(title,msg,type){
  $("toastTitle").textContent=title;
  $("toastMsg").textContent=msg;
  const b=$("toastBadge");
  b.className="badge "+(type||"warn");
  b.textContent=(type==="good")?"推进":(type==="bad"?"提示":"事件");
  toast.classList.remove("show"); void toast.offsetWidth; toast.classList.add("show");
}
function setEvt(text){ $("lastEvt").textContent=`${text} @ ${stamp()}`; }

function setActTag(){ $("actTag").textContent = CFG.acts[S.act-1].name; }
function setWishTag(){ $("wishTag").textContent = S.wishText || "未写入"; }

function showLamp(title, sub){
  $("lampTitle").textContent = title;
  $("lampSub").textContent = sub;
  lamp.classList.remove("show");
  void lamp.offsetWidth;
  lamp.classList.add("show");
  setTimeout(()=>lamp.classList.remove("show"), 1700);
}

function showBranchUI(on){
  S.branchPending = !!on;
  if (on){
    branchBar.classList.add("show");
  } else {
    branchBar.classList.remove("show");
  }
}

/* =========================
   终点站
========================= */
function hardEndShow(){
  S.ended = true;
  showBranchUI(false);

  $("cardTitle").textContent = "终点站广播";
  $("cardBody").textContent = CFG.finalAnnouncement;

  setEvt("终点站已到达");
  showToast("终点站", CFG.finalAnnouncement, "good");
}

/* =========================
   主线推进（三幕）
========================= */
function updateAct(){
  const newAct = Math.min(3, 1 + Math.floor(S.ordersInternal / CFG.actStep));
  if (newAct !== S.act){
    S.act = newAct;
    setActTag();
    const a = CFG.acts[S.act - 1];
    showToast("主线推进", `${a.name}\n${a.cue}`, "warn");
    setEvt(`主线推进：${a.name}`);
  }
}

/* =========================
   许愿词
========================= */
function setWish(){
  if (S.ended) return;
  const v = window.prompt("输入许愿词（如：平安/恋爱/发财/回家）：", (S.wishText==="未写入"?"平安":S.wishText));
  if (!v) return;
  S.wishText = v.trim().slice(0,8) || "未写入";
  S.wishPendingOnce = true;
  setWishTag();
  showToast("许愿已写入", `下一单会把「${S.wishText}」写进剧情`, "good");
  setEvt("已写入许愿词");
}

/* =========================
   大礼物队列
========================= */
function maybeUnlockGifts(){
  while (S.giftUnlockIdx < CFG.giftUnlockOrders.length &&
         S.ordersInternal >= CFG.giftUnlockOrders[S.giftUnlockIdx]) {
    S.pendingGifts.push(CFG.giftSequence[S.giftUnlockIdx]);
    S.giftUnlockIdx += 1;
  }
}
function awardBigGift(kind, rewards, events){
  if (kind==="玲娜贝尔"){
    if (S.dollLeft>0){ S.dollLeft-=1; rewards.push("玲娜贝尔"); events.push(pick("doll")); return; }
  } else {
    if (S.scarfLeft>0){ S.scarfLeft-=1; rewards.push("围巾"); events.push(pick("scarf")); return; }
  }
  rewards.push("升级回礼");
  events.push(pick("upgrade"));
}
function maybeRevealBigGiftAnyBranch(rewards, events){
  if (S.stationLight > 0 && S.pendingGifts.length > 0){
    S.stationLight -= 1;
    const g = S.pendingGifts[0];
    showLamp("站台灯亮起", `回礼车厢开启\n即将揭晓：${g === "玲娜贝尔" ? "玲娜贝尔" : "围巾"}`);
    events.push("站台灯亮起：回礼车厢开启");
    const real = S.pendingGifts.shift();
    awardBigGift(real, rewards, events);
  }
}

/* =========================
   岔路：每3单出现一次（手机不弹窗，直接显示ABC按钮）
========================= */
function maybeTriggerBranch(){
  if (S.ordersInternal>0 && S.ordersInternal % CFG.branchEvery===0){
    showBranchUI(true);
    showToast("岔路出现", pick("bigGiftCue") + "\n（请点 A / B / C）", "warn");
    setEvt("岔路等待选择");
    return true;
  }
  return false;
}

function chooseBranch(letter){
  if (S.ended) return;
  if (!S.branchPending) return;

  showBranchUI(false);

  const rewards=[], events=[];
  events.push(letter==="A"?pick("branchA"):letter==="B"?pick("branchB"):pick("branchC"));

  // 默认手链
  rewards.push("手链");

  if (letter==="A"){
    rewards.push("随行回礼：已到位");
  }

  if (letter==="B"){
    rewards.push("章节推进");
    S.stationLight += 1;
    events.push("站牌闪烁：站台灯已解锁");

    if (S.cUnlocked < S.cTotal){
      S.cUnlocked = Math.min(S.cTotal, S.cUnlocked + CFG.cUnlockPerB);
      rewards.push("补给权限+1");
      events.push("提示音落下：补给权限被点亮");
    }
  }

  if (letter==="C"){
    S.cBuffForNext = true;
    events.push("站台广播：下一单将触发补给");
  }

  // 任意岔路可亮灯揭晓
  maybeRevealBigGiftAnyBranch(rewards, events);

  const evtLine = `触发随机事件：${events[0] || "…"}`;
  const rewardLine = `获得：\n- ${rewards.join("\n- ")}`;

  $("cardTitle").textContent = "岔路结果卡";
  $("cardBody").textContent  = `${evtLine}\n${rewardLine}`;

  const toastType = (rewards.includes("围巾") || rewards.includes("玲娜贝尔")) ? "warn" : "good";
  showToast("岔路播报", `${evtLine}\n${rewardLine}`, toastType);
  setEvt("岔路已结算");
}

/* =========================
   结算一单：手机点普通/隐藏直接结算
========================= */
function settleOne(type){ // type: "O" | "H"
  if (S.ended) return;

  if (S.branchPending){
    showToast("岔路进行中","请先点 A / B / C 完成岔路。","bad");
    return;
  }

  if (S.commonLeft + S.hiddenLeft <= 0){
    hardEndShow();
    return;
  }

  const rewards=[], events=[];

  // 默认手链（无限）
  rewards.push("手链");
  events.push("回礼出现：手链轻轻落下");

  // 基础壳扣库存
  if (type==="H"){
    if (S.hiddenLeft>0){
      S.hiddenLeft -= 1;
      S.addStreak = Math.max(S.addStreak, CFG.hiddenAddStreak);
      events.unshift(pick("hidden"));
      rewards.push("隐藏剧情已点亮");
    } else {
      if (S.commonLeft<=0){ hardEndShow(); return; }
      S.commonLeft -= 1;
      events.unshift("系统提示：隐藏已用尽，本次按普通结算");
    }
  } else {
    if (S.commonLeft<=0){ hardEndShow(); return; }
    S.commonLeft -= 1;
    events.unshift(pick("base"));
  }

  // 许愿词写入：下一单写一次
  if (S.wishPendingOnce && S.wishText && S.wishText!=="未写入"){
    S.wishPendingOnce = false;
    events.splice(1, 0, `许愿车票已盖章：愿你「${S.wishText}」`);
  }

  S.ordersInternal += 1;
  maybeUnlockGifts();
  updateAct();
  setActTag();

  let addPaid = false;
  const cAvail = Math.max(0, S.cUnlocked - S.cUsed);

  // 1) 补给：强制下一单加拆（隐形）
  if (S.forceAddNext && !addPaid){
    S.forceAddNext = false;
    if (S.commonLeft > 0){
      S.commonLeft -= 1;
      addPaid = true;
      rewards.push("加拆手机壳");
      events.push(pick("add"));
    } else {
      rewards.push("升级回礼");
      events.push(pick("upgrade"));
    }
  }

  // 2) 隐藏三连加拆
  if (!addPaid && S.addStreak > 0){
    if (S.commonLeft > 0){
      S.commonLeft -= 1;
      addPaid = true;
      rewards.push("加拆手机壳");
      events.push(pick("add"));
    } else {
      rewards.push("升级回礼");
      events.push(pick("upgrade"));
    }
    S.addStreak -= 1;
    S.cBuffForNext = false;
  }

  // 3) C写入下一单
  if (!addPaid && S.cBuffForNext){
    if (cAvail > 0 && S.commonLeft > 0){
      S.commonLeft -= 1;
      S.cUsed += 1;
      addPaid = true;
      rewards.push("加拆手机壳");
      events.push(pick("add"));
    } else {
      rewards.push("升级回礼");
      events.push(pick("upgrade"));
    }
    S.cBuffForNext = false;
  }

  const evtLine = `触发随机事件：${events[0] || "…"}`;
  const displayRewards = addPaid ? rewards.filter(r => r !== "手链") : rewards;
  const rewardLine = `获得：${displayRewards.join(" + ")}`;
  const addLine = addPaid ? "加拆：已兑现（额外+1壳）" : "";

  $("cardTitle").textContent = "结果卡：已结算";
  $("cardBody").textContent  = addPaid
    ? `${evtLine}\n${rewardLine}\n${addLine}`
    : `${evtLine}\n${rewardLine}`;

  const toastType = (displayRewards.includes("加拆手机壳") || displayRewards.includes("围巾") || displayRewards.includes("玲娜贝尔")) ? "warn" : "good";
  showToast("本单播报", addPaid ? `${evtLine}\n${rewardLine}\n${addLine}` : `${evtLine}\n${rewardLine}`, toastType);
  setEvt("本单已结算");

  // 库存耗尽 -> 终点站
  if (S.commonLeft + S.hiddenLeft <= 0){
    hardEndShow();
    return;
  }

  // 每3单触发岔路
  maybeTriggerBranch();
}

/* =========================
   重置
========================= */
function resetAll(){
  initDecks();
  S.ended = false;

  S.commonLeft = CFG.common;
  S.hiddenLeft = CFG.hidden;
  S.scarfLeft  = CFG.scarf;
  S.dollLeft   = CFG.doll;

  S.addStreak = 0;
  S.ordersInternal = 0;

  S.cTotal = CFG.cAddTotal;
  S.cUnlocked = 0;
  S.cUsed = 0;
  S.cBuffForNext = false;

  S.giftUnlockIdx = 0;
  S.pendingGifts = [];

  S.stationLight = 0;

  S.act = 1;
  setActTag();

  S.wishText = "未写入";
  S.wishPendingOnce = false;
  setWishTag();

  S.forceAddNext = false;

  showBranchUI(false);

  $("cardTitle").textContent = "结果卡：等待结算";
  $("cardBody").textContent  = "点击「普通」或「隐藏」即可结算本单。";
  $("lastEvt").textContent   = "-";

  showToast("已重置","点击普通/隐藏=结算｜补给=强制下一单加拆｜许愿=写入剧情", "warn");
}

/* =========================
   绑定：手机点击
========================= */
$("btnO").addEventListener("click", ()=>settleOne("O"), {passive:true});
$("btnH").addEventListener("click", ()=>settleOne("H"), {passive:true});

$("btnA").addEventListener("click", ()=>chooseBranch("A"), {passive:true});
$("btnB").addEventListener("click", ()=>chooseBranch("B"), {passive:true});
$("btnC").addEventListener("click", ()=>chooseBranch("C"), {passive:true});

$("btnWish").addEventListener("click", ()=>setWish(), {passive:true});
$("btnSupply").addEventListener("click", ()=>{
  if (S.ended) return;
  S.forceAddNext = true;      // 隐形：不提示观众
  showToast("补给已就位","下一单将触发补给（加拆）", "good"); // 你如果也不想提示，把这行删掉
  setEvt("补给已准备");
}, {passive:true});

$("btnReset").addEventListener("click", ()=>resetAll(), {passive:true});

initDecks();
resetAll();
</script>
</body>
</html>
