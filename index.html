<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>冬日列车 · 手机版</title>

  <style>
    :root{
      --bg0:#070a14;
      --bg1:#0b1020;
      --txt:#eef0ff;
      --mut:rgba(238,240,255,.72);
      --mut2:rgba(238,240,255,.55);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 26px rgba(0,0,0,.35);
      --radius: 22px;
      --good:#6be7a8;
      --warn:#ffd36b;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC","Noto Sans SC", Arial, "Microsoft YaHei", sans-serif;
      color:var(--txt);
      overflow:hidden;
      background:
        radial-gradient(900px 700px at 18% 12%, rgba(96, 122, 255, .33) 0%, rgba(12, 18, 44, 0) 56%),
        radial-gradient(760px 520px at 78% 22%, rgba(255, 211, 107, .16) 0%, rgba(12, 18, 44, 0) 62%),
        radial-gradient(920px 620px at 50% 100%, rgba(107, 231, 168, .10) 0%, rgba(12, 18, 44, 0) 62%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 60%, #060812 100%);
    }

    /* 雪花（纯CSS） */
    .snow, .snow:before, .snow:after{
      position:fixed; inset:-200px 0 0 0; content:"";
      pointer-events:none;
      background-image:
        radial-gradient(2px 2px at 10% 10%, rgba(255,255,255,.60) 40%, rgba(255,255,255,0) 42%),
        radial-gradient(1px 1px at 40% 30%, rgba(255,255,255,.55) 45%, rgba(255,255,255,0) 47%),
        radial-gradient(2px 2px at 70% 20%, rgba(255,255,255,.50) 40%, rgba(255,255,255,0) 42%),
        radial-gradient(1px 1px at 90% 60%, rgba(255,255,255,.45) 45%, rgba(255,255,255,0) 47%),
        radial-gradient(2px 2px at 25% 80%, rgba(255,255,255,.40) 40%, rgba(255,255,255,0) 42%),
        radial-gradient(1px 1px at 55% 75%, rgba(255,255,255,.48) 45%, rgba(255,255,255,0) 47%),
        radial-gradient(2px 2px at 80% 88%, rgba(255,255,255,.38) 40%, rgba(255,255,255,0) 42%);
      background-size: 460px 460px;
      opacity:.22;
      filter: blur(.2px);
      animation: snowFall 20s linear infinite;
    }
    .snow:before{ opacity:.14; background-size: 640px 640px; animation-duration: 28s; transform: translateY(-140px); }
    .snow:after{ opacity:.10; background-size: 820px 820px; animation-duration: 36s; transform: translateY(-240px); filter: blur(.6px); }
    @keyframes snowFall{0%{transform: translateY(-260px)}100%{transform: translateY(980px)}}

    .wrap{height:100%; display:flex; flex-direction:column; padding:14px;}
    .stage{
      flex:1;
      border-radius: calc(var(--radius) + 10px);
      padding:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.085), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .stage:before{
      content:""; position:absolute; inset:-2px;
      border-radius: calc(var(--radius) + 12px);
      background:
        radial-gradient(820px 260px at 18% 0%, rgba(255,211,107,.16), rgba(0,0,0,0) 60%),
        radial-gradient(820px 260px at 82% 0%, rgba(96,122,255,.18), rgba(0,0,0,0) 60%),
        radial-gradient(820px 260px at 50% 120%, rgba(107,231,168,.10), rgba(0,0,0,0) 60%);
      pointer-events:none; opacity:.88; filter: blur(.2px);
    }

    .card{
      position:relative;
      border-radius: var(--radius);
      padding:16px 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
    }

    #cardTitle{
      font-size: clamp(30px, 6.2vw, 44px);
      font-weight: 1150;
      letter-spacing: .6px;
      line-height:1.12;
    }
    #cardBody{
      margin-top:12px;
      font-size: clamp(18px, 4.4vw, 26px);
      color: rgba(238,240,255,.94);
      line-height:1.6;
      white-space: pre-line;
    }

    /* 能量条 */
    .energyWrap{
      margin-top:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .energyLabel{ font-size:13px; color: var(--mut); }
    .bar{
      flex:1;
      min-width: 160px;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      box-shadow: 0 8px 18px rgba(0,0,0,.28);
    }
    .fill{
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,211,107,.55), rgba(96,122,255,.45), rgba(107,231,168,.35));
      transition: width .18s ease;
    }
    .energyText{ font-size:13px; color: rgba(238,240,255,.86); white-space:nowrap; }

    /* 按钮区 */
    .panel{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      position:relative;
      z-index:5;
    }
    button{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
      color: var(--txt);
      padding:14px 12px;
      border-radius: 16px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      transition: transform .06s ease, background .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
      -webkit-tap-highlight-color: transparent;
    }
    button:active{transform: scale(.985);}
    button:hover{background: rgba(255,255,255,.10);}
    .btnGood{border-color: rgba(107,231,168,.35); background: rgba(107,231,168,.12);}
    .btnWarn{border-color: rgba(255,211,107,.35); background: rgba(255,211,107,.12);}

    /* Toast */
    .toast{
      position:fixed; left:50%; top:8%;
      transform: translateX(-50%) scale(.98);
      width: min(680px, 92vw);
      padding:16px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(10,14,34,.82);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      z-index:9999;
      opacity:0;
      pointer-events:none;
      white-space:pre-line;
    }
    .toast.show{animation: pop 2.8s ease forwards;}
    @keyframes pop{
      0%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.96);}
      12%{opacity:1; transform:translateX(-50%) translateY(0px) scale(1);}
      82%{opacity:1; transform:translateX(-50%) translateY(0px) scale(1);}
      100%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.98);}
    }
    .toastTitle{font-size:18px; font-weight:1000;}
    .toastMsg{margin-top:10px; font-size:16px; line-height:1.55; color: rgba(238,240,255,.94);}

    /* 站台灯全屏提示 */
    .lamp{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:10000;
      background:
        radial-gradient(900px 520px at 50% 35%, rgba(255,211,107,.26) 0%, rgba(0,0,0,0) 60%),
        rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .lamp.show{display:flex; animation: lampPop 1.55s ease forwards;}
    @keyframes lampPop{
      0%{opacity:0; transform: scale(.985)}
      12%{opacity:1; transform: scale(1)}
      78%{opacity:1; transform: scale(1)}
      100%{opacity:0; transform: scale(.99)}
    }
    .lampCard{
      width:min(680px, 92vw);
      border-radius: 28px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(10,14,34,.86);
      box-shadow: var(--shadow);
      padding:20px;
      position:relative;
      overflow:hidden;
    }
    .lampTitle{
      font-size: clamp(34px, 7vw, 52px);
      font-weight: 1250;
      letter-spacing: 1px;
      line-height: 1.05;
    }
    .lampSub{
      margin-top:12px;
      font-size: clamp(18px, 4.6vw, 26px);
      color: rgba(238,240,255,.94);
      line-height:1.55;
      white-space:pre-line;
    }
  </style>
</head>

<body>
  <div class="snow" aria-hidden="true"></div>

  <div class="wrap">
    <div class="stage">
      <div class="card">
        <div id="cardTitle">结果卡</div>
        <div id="cardBody">准备开拆。</div>

        <div class="energyWrap">
          <div class="energyLabel">站台灯能量（满格必出回礼）</div>
          <div class="bar"><div class="fill" id="fill"></div></div>
          <div class="energyText" id="energyText">0 / 3</div>
        </div>
      </div>

      <!-- 点普通/隐藏直接结算 -->
      <div class="panel">
        <button class="btnGood" id="btnCommon">普通</button>
        <button class="btnWarn" id="btnHidden">隐藏</button>
        <button id="btnWish">许愿</button>
      </div>

      <div class="panel">
        <button id="btnSupply">补给</button>
        <button id="btnReset">重置</button>
        <button disabled style="opacity:.45;"> </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="toastTitle" id="toastTitle">提示</div>
    <div class="toastMsg" id="toastMsg">内容</div>
  </div>

  <!-- 站台灯 -->
  <div class="lamp" id="lamp">
    <div class="lampCard">
      <div class="lampTitle" id="lampTitle">站台灯亮起</div>
      <div class="lampSub" id="lampSub">回礼车厢开启</div>
    </div>
  </div>

<script>
/* =========================
   配置
========================= */
const CFG = {
  common: 519,
  hidden: 11,
  scarf: 12,
  doll: 3,

  hiddenAddStreak: 3,

  // ✅ 随行回礼（手链）= 33%
  braceletRate: 0.33,

  // ✅ 每轮能量 +1，满3必出回礼
  energyMax: 3,

  // ✅ 回礼池（除手链外的权重池）
  giftWeights: [
    { key:"add",   w:65 },   // 加拆更常见
    { key:"scarf", w:28 },
    { key:"doll",  w:7  }
  ],

  finalAnnouncement:
`各位乘客我们的终点站 —— 家 已经到达
请各位收拾好自己的盒子并检查和确认是否有疑问
如有疑问请联系客服为您检查`
};

/* =========================
   文案池（不出现 /…/…）
========================= */
const TEXT = {
  base: [
    "列车广播轻响：雪夜在窗外慢慢铺开",
    "车厢灯带亮起：空气里多了一点暖",
    "站台风铃一响：冬天的故事开始推进"
  ],
  hidden: [
    "隐藏车厢被点亮：霜面裂开一道光",
    "站牌翻面：出现一张隐藏车票",
    "铃声轻响：隐藏纪念章落在掌心"
  ],
  add: [
    "补给车厢接驳：随行礼已装载",
    "暖风机启动：多一份安心被递上",
    "补给箱弹开：额外守护已到账"
  ],
  bracelet: [
    "随行印记：手链闪着微光落入礼袋",
    "回礼出现：手链轻轻落下"
  ],
  scarf: [
    "围炉小站亮灯：冬日围巾悄悄系上",
    "北风被挡在门外：围巾到位"
  ],
  doll: [
    "车厢尽头出现玩偶座：玲娜贝尔入座",
    "暖灯聚焦：玲娜贝尔成为今晚主角"
  ],
  lamp: [
    "站台灯亮起：回礼车厢开启",
    "站台灯亮起：暖光照进车厢"
  ],
  wish: [
    "许愿车票已盖章：愿你「{W}」",
    "车厢广播低声说：愿你「{W}」"
  ]
};

function shuffle(a){
  a=a.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
const DECK={}, IDX={};
function initDecks(){
  for(const k of Object.keys(TEXT)){
    DECK[k]=shuffle(TEXT[k]);
    IDX[k]=0;
  }
}
function pick(k){
  const d=DECK[k]||["…"];
  const i=IDX[k]||0;
  IDX[k]=i+1;
  return d[i % d.length];
}
function weightedPick(arr){
  let sum=0;
  for (const it of arr) sum += it.w;
  let r = Math.random() * sum;
  for (const it of arr){
    r -= it.w;
    if (r <= 0) return it.key;
  }
  return arr[arr.length-1].key;
}

/* =========================
   状态
========================= */
const S = {
  ended:false,

  commonLeft: CFG.common,
  hiddenLeft: CFG.hidden,
  scarfLeft:  CFG.scarf,
  dollLeft:   CFG.doll,

  addStreak: 0,
  forceAddNext:false,

  energy: 0,

  wishText: "未写入",
  wishPendingOnce:false
};

const $ = (id)=>document.getElementById(id);
const toast = $("toast");
const lamp  = $("lamp");

function showToast(title,msg){
  $("toastTitle").textContent=title;
  $("toastMsg").textContent=msg;
  toast.classList.remove("show"); void toast.offsetWidth; toast.classList.add("show");
}
function showLamp(title, sub){
  $("lampTitle").textContent = title;
  $("lampSub").textContent = sub;
  lamp.classList.remove("show"); void lamp.offsetWidth; lamp.classList.add("show");
  setTimeout(()=>lamp.classList.remove("show"), 1600);
}
function renderEnergy(){
  const pct = (S.energy/CFG.energyMax)*100;
  $("fill").style.width = `${pct}%`;
  $("energyText").textContent = `${S.energy} / ${CFG.energyMax}`;
}
function setCard(title, body){
  $("cardTitle").textContent = title;
  $("cardBody").textContent = body;
}
function hardEndShow(){
  S.ended = true;
  setCard("终点站广播", CFG.finalAnnouncement);
  showToast("终点站", CFG.finalAnnouncement);
}

/* =========================
   许愿
========================= */
function setWish(){
  if (S.ended) return;
  const v = window.prompt("输入许愿词（平安/恋爱/发财/回家）：", (S.wishText==="未写入"?"平安":S.wishText));
  if (!v) return;
  S.wishText = v.trim().slice(0,8) || "未写入";
  S.wishPendingOnce = true;
  showToast("许愿已写入", "下一轮会把许愿写进剧情。");
}

/* =========================
   回礼发放（非保底/保底共用）
   - 手链优先：先按33%判定手链
   - 否则从权重池抽：加拆/围巾/玲娜贝尔
========================= */
function rollGift(){
  // 手链优先
  if (Math.random() < CFG.braceletRate){
    return { type:"bracelet", text:"手链", evt: pick("bracelet"), addPaid:false };
  }

  const k = weightedPick(CFG.giftWeights);

  if (k==="add"){
    if (S.commonLeft > 0){
      S.commonLeft -= 1;
      return { type:"add", text:"加拆手机壳", evt: pick("add"), addPaid:true };
    }
    return { type:"upgrade", text:"升级回礼", evt: pick("lamp"), addPaid:false };
  }

  if (k==="scarf"){
    if (S.scarfLeft > 0){
      S.scarfLeft -= 1;
      return { type:"scarf", text:"围巾", evt: pick("scarf"), addPaid:false };
    }
    return { type:"upgrade", text:"升级回礼", evt: pick("lamp"), addPaid:false };
  }

  // doll
  if (S.dollLeft > 0){
    S.dollLeft -= 1;
    return { type:"doll", text:"玲娜贝尔", evt: pick("doll"), addPaid:false };
  }
  return { type:"upgrade", text:"升级回礼", evt: pick("lamp"), addPaid:false };
}

/* =========================
   结算（点普通/隐藏直接结算）
   - 每轮能量+1
   - 能量满格：必出回礼（保底），能量清零
   - 补给：强制下一轮加拆（不靠概率）
   - 隐藏：触发三连加拆（你手动点隐藏才会触发）
========================= */
function settleAs(type){
  if (S.ended) return;

  if (S.commonLeft + S.hiddenLeft <= 0){
    hardEndShow();
    return;
  }

  const events = [];
  const rewards = [];
  let addPaid = false;

  // 扣基础壳
  if (type==="hidden"){
    if (S.hiddenLeft > 0){
      S.hiddenLeft -= 1;
      events.push(pick("hidden"));
      S.addStreak = Math.max(S.addStreak, CFG.hiddenAddStreak);
    }else{
      if (S.commonLeft <= 0){ hardEndShow(); return; }
      S.commonLeft -= 1;
      events.push(pick("base"));
    }
  }else{
    if (S.commonLeft <= 0){ hardEndShow(); return; }
    S.commonLeft -= 1;
    events.push(pick("base"));
  }

  // 许愿写入（下一轮写一次）
  if (S.wishPendingOnce && S.wishText && S.wishText!=="未写入"){
    S.wishPendingOnce = false;
    events.push(pick("wish").replace("{W}", S.wishText));
  }

  // ✅ 先处理强制补给（下一轮加拆）—你点了补给就必出
  if (S.forceAddNext){
    S.forceAddNext = false;
    if (S.commonLeft > 0){
      S.commonLeft -= 1;
      addPaid = true;
      rewards.push("加拆手机壳");
      events.push(pick("add"));
    }else{
      rewards.push("升级回礼");
      events.push(pick("lamp"));
    }
  }

  // ✅ 隐藏三连加拆
  if (!addPaid && S.addStreak > 0){
    if (S.commonLeft > 0){
      S.commonLeft -= 1;
      addPaid = true;
      rewards.push("加拆手机壳");
      events.push(pick("add"));
    }else{
      rewards.push("升级回礼");
      events.push(pick("lamp"));
    }
    S.addStreak -= 1;
  }

  // ✅ 能量推进
  S.energy = Math.min(CFG.energyMax, S.energy + 1);
  renderEnergy();

  // ✅ 本轮随机回礼（可选）：如果你想“每轮都有概率出回礼”，打开下面这一段
  // 这里设置成：如果本轮还没出加拆，则有一定概率出回礼（手链优先）
  // 你如果想更强刺激，把 0.45 改大，比如 0.6
  let giftThisRound = null;
  if (!addPaid && Math.random() < 0.45){
    giftThisRound = rollGift();
    rewards.push(giftThisRound.text);
    events.push(giftThisRound.evt);
    if (giftThisRound.addPaid) addPaid = true;
  }

  // ✅ 保底：能量满格必出回礼（站台灯亮起）
  if (S.energy >= CFG.energyMax){
    S.energy = 0;
    renderEnergy();
    showLamp("站台灯亮起", pick("lamp"));

    const g = rollGift();
    rewards.push(g.text);
    events.push(g.evt);
    if (g.addPaid) addPaid = true;
  }

  // 展示：如果加拆出现，获得里不显示“手链 + 加拆”
  const displayRewards = addPaid ? rewards.filter(x => x !== "手链") : rewards;

  const evtLine = `触发随机事件：${events[0] || "…"}`;
  const rewardLine = displayRewards.length ? `获得：${displayRewards.join(" + ")}` : "获得：-";

  setCard("结果卡", `${evtLine}\n${rewardLine}`);
  showToast("本轮结算", `${evtLine}\n${rewardLine}`);

  // 终点站
  if (S.commonLeft + S.hiddenLeft <= 0){
    setTimeout(hardEndShow, 350);
    return;
  }
}

/* =========================
   补给：强制下一轮加拆
========================= */
function setSupply(){
  if (S.ended) return;
  S.forceAddNext = true;
  showToast("补给已安排", "下一轮会触发加拆。");
}

/* =========================
   重置
========================= */
function resetAll(){
  initDecks();
  S.ended=false;

  S.commonLeft=CFG.common;
  S.hiddenLeft=CFG.hidden;
  S.scarfLeft=CFG.scarf;
  S.dollLeft=CFG.doll;

  S.addStreak=0;
  S.forceAddNext=false;

  S.energy=0;
  renderEnergy();

  S.wishText="未写入";
  S.wishPendingOnce=false;

  setCard("结果卡", "准备开拆。");
  showToast("已重置", "可以开始。");
}

/* =========================
   绑定
========================= */
$("btnCommon").onclick = ()=> settleAs("common");
$("btnHidden").onclick = ()=> settleAs("hidden");
$("btnSupply").onclick = ()=> setSupply();
$("btnWish").onclick   = ()=> setWish();
$("btnReset").onclick  = ()=> resetAll();

initDecks();
resetAll();
</script>
</body>
</html>
