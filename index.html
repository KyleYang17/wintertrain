<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>冬日列车</title>

  <style>
    :root{
      --bg0:#070a14;
      --bg1:#0b1020;
      --txt:#eef0ff;
      --mut:rgba(238,240,255,.72);
      --mut2:rgba(238,240,255,.55);
      --glass: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --good:#6be7a8;
      --warn:#ffd36b;
      --bad:#ff6b8a;
      --shadow: 0 22px 78px rgba(0,0,0,.52);
      --shadow2: 0 10px 34px rgba(0,0,0,.35);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC","Noto Sans SC", Arial, "Microsoft YaHei", sans-serif;
      color:var(--txt);
      overflow:hidden;
      background:
        radial-gradient(1200px 800px at 18% 12%, rgba(96, 122, 255, .33) 0%, rgba(12, 18, 44, 0) 56%),
        radial-gradient(900px 600px at 78% 22%, rgba(255, 211, 107, .16) 0%, rgba(12, 18, 44, 0) 62%),
        radial-gradient(1100px 700px at 50% 100%, rgba(107, 231, 168, .10) 0%, rgba(12, 18, 44, 0) 62%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 60%, #060812 100%);
      -webkit-tap-highlight-color: transparent;
    }

    /* 雪花（纯CSS） */
    .snow, .snow:before, .snow:after{
      position:fixed; inset:-200px 0 0 0; content:"";
      pointer-events:none;
      background-image:
        radial-gradient(2px 2px at 10% 10%, rgba(255,255,255,.60) 40%, rgba(255,255,255,0) 42%),
        radial-gradient(1px 1px at 40% 30%, rgba(255,255,255,.55) 45%, rgba(255,255,255,0) 47%),
        radial-gradient(2px 2px at 70% 20%, rgba(255,255,255,.50) 40%, rgba(255,255,255,0) 42%),
        radial-gradient(1px 1px at 90% 60%, rgba(255,255,255,.45) 45%, rgba(255,255,255,0) 47%),
        radial-gradient(2px 2px at 25% 80%, rgba(255,255,255,.40) 40%, rgba(255,255,255,0) 42%),
        radial-gradient(1px 1px at 55% 75%, rgba(255,255,255,.48) 45%, rgba(255,255,255,0) 47%),
        radial-gradient(2px 2px at 80% 88%, rgba(255,255,255,.38) 40%, rgba(255,255,255,0) 42%);
      background-size: 460px 460px;
      opacity:.26;
      filter: blur(.2px);
      animation: snowFall 20s linear infinite;
    }
    .snow:before{
      opacity:.16; background-size: 640px 640px;
      animation-duration: 28s; transform: translateY(-140px);
    }
    .snow:after{
      opacity:.12; background-size: 820px 820px;
      animation-duration: 36s; transform: translateY(-240px);
      filter: blur(.6px);
    }
    @keyframes snowFall{0%{transform: translateY(-260px)}100%{transform: translateY(980px)}}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .wrap{min-height:100vh; display:flex; flex-direction:column;}

    /* 顶栏 */
    .top{
      padding:18px 20px 16px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:14px; flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border-bottom: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 8px 28px rgba(0,0,0,.30);
    }
    .title{
      font-size:26px; font-weight:1000; letter-spacing:.6px;
      display:flex; align-items:center; gap:10px;
    }
    .title:before{
      content:""; width:10px; height:10px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,211,107,.50), rgba(107,231,168,.20));
      box-shadow: 0 0 18px rgba(255,211,107,.35);
    }
    .sub{font-size:12px; color:var(--mut); line-height:1.7;}
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:9px 12px; border-radius:999px; font-size:12px; color:var(--mut);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
    }
    .pill b{color:var(--txt)}

    /* 舞台 */
    .main{flex:1; display:flex; align-items:center; justify-content:center; padding:20px;}
    .stage{
      width:min(1380px, 97vw);
      border-radius: calc(var(--radius) + 10px);
      padding:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.085), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .stage:before{
      content:""; position:absolute; inset:-2px;
      border-radius: calc(var(--radius) + 12px);
      background:
        radial-gradient(820px 260px at 18% 0%, rgba(255,211,107,.16), rgba(0,0,0,0) 60%),
        radial-gradient(820px 260px at 82% 0%, rgba(96,122,255,.18), rgba(0,0,0,0) 60%),
        radial-gradient(820px 260px at 50% 120%, rgba(107,231,168,.10), rgba(0,0,0,0) 60%);
      pointer-events:none; opacity:.88; filter: blur(.2px);
    }
    .row{
      position:relative;
      border-radius: var(--radius);
      padding:18px 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;
      margin-bottom:16px;
    }
    .headline{font-size:18px; font-weight:950; letter-spacing:.3px;}
    .hint{margin-top:8px; font-size:14px; color:var(--mut); line-height:1.75; max-width:1100px;}

    /* 舞台级大字幕：结果卡 */
    #cardTitle{
      font-size: clamp(34px, 2.7vw, 46px);
      font-weight: 1150;
      letter-spacing: .6px;
      line-height:1.16;
    }
    #cardBody{
      margin-top:12px;
      font-size: clamp(22px, 1.75vw, 30px);
      color: rgba(238,240,255,.94);
      line-height:1.62;
      white-space: pre-line;
    }

    /* 额外：主线/许愿显示（小但清晰） */
    .metaLine{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
      color: var(--mut);
      font-size:13px;
    }
    .metaTag{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(238,240,255,.86);
    }
    .metaTag b{color:rgba(238,240,255,.95)}

    /* 最近3条 */
    .kpi{
      border-radius: var(--radius);
      padding:14px 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .chip{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size:13px;
      color: rgba(238,240,255,.90);
      white-space:nowrap;
    }
    .chip.m{color:var(--mut2); background: rgba(255,255,255,.03);}

    /* Toast：大字幕广播 */
    .toast{
      position:fixed; left:50%; top:10%;
      transform: translateX(-50%) scale(.98);
      min-width: min(1180px, 95vw);
      padding:20px;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(10,14,34,.80);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      z-index:9999;
      opacity:0;
      pointer-events:none;
      white-space:pre-line;
    }
    .toast.show{animation: pop 3.0s ease forwards;}
    @keyframes pop{
      0%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.96);}
      12%{opacity:1; transform:translateX(-50%) translateY(0px) scale(1);}
      82%{opacity:1; transform:translateX(-50%) translateY(0px) scale(1);}
      100%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.98);}
    }
    .toast .t1{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .toast .tt{font-size:22px; font-weight:1150;}
    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--mut);
      font-size:12px;
      white-space:nowrap;
    }
    .badge.good{border-color: rgba(107,231,168,.35); background: rgba(107,231,168,.12); color: rgba(238,240,255,.92);}
    .badge.warn{border-color: rgba(255,211,107,.35); background: rgba(255,211,107,.12); color: rgba(238,240,255,.92);}
    .badge.bad{border-color: rgba(255,107,138,.35); background: rgba(255,107,138,.12); color: rgba(238,240,255,.92);}
    .toast .msg{margin-top:12px; font-size:20px; color: rgba(238,240,255,.94); line-height:1.6;}

    /* 岔路 overlay */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:none; align-items:center; justify-content:center;
      z-index:9998;
    }
    .overlay.show{display:flex;}
    .choiceBox{
      width:min(1200px, 95vw);
      border-radius: 30px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(10,14,34,.84);
      box-shadow: var(--shadow);
      padding:22px;
      position:relative; overflow:hidden;
    }
    .choiceTop{display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .choiceTop .cTitle{font-size:24px; font-weight:1150;}
    .choiceTop .cHint{font-size:12px; color:var(--mut);}
    .choices{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:16px;
    }
    .opt{
      padding:20px;
      border-radius:24px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      display:flex; flex-direction:column; gap:10px; align-items:flex-start;
      transition: transform .12s ease, background .12s ease;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
    }
    .opt:hover{transform: translateY(-2px); background: rgba(255,255,255,.09);}
    .opt .letter{
      font-size:62px;
      font-weight:1200;
      line-height:1;
      letter-spacing:1px;
      text-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .opt .sub{font-size:12px; color:var(--mut);}

    /* 站台灯 · 舞台级提示（全屏大字，一眼懂） */
    .lamp{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:10000;
      background:
        radial-gradient(900px 500px at 50% 35%, rgba(255,211,107,.26) 0%, rgba(0,0,0,0) 60%),
        rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .lamp.show{display:flex; animation: lampPop 1.65s ease forwards;}
    @keyframes lampPop{
      0%{opacity:0; transform: scale(.98)}
      12%{opacity:1; transform: scale(1)}
      78%{opacity:1; transform: scale(1)}
      100%{opacity:0; transform: scale(.99)}
    }
    .lampCard{
      width:min(1180px, 94vw);
      border-radius: 34px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(10,14,34,.86);
      box-shadow: var(--shadow);
      padding:26px;
      position:relative;
      overflow:hidden;
    }
    .lampCard:before{
      content:"";
      position:absolute; inset:-2px;
      border-radius: 36px;
      background:
        radial-gradient(820px 280px at 50% 0%, rgba(255,211,107,.30), rgba(0,0,0,0) 60%),
        radial-gradient(820px 280px at 50% 120%, rgba(96,122,255,.18), rgba(0,0,0,0) 60%);
      pointer-events:none;
      opacity:.9;
    }
    .lampTitle{
      font-size: clamp(46px, 4vw, 70px);
      font-weight: 1250;
      letter-spacing: 1px;
      line-height: 1.05;
      text-shadow: 0 18px 50px rgba(0,0,0,.55);
    }
    .lampSub{
      margin-top:12px;
      font-size: clamp(22px, 1.9vw, 32px);
      color: rgba(238,240,255,.94);
      line-height:1.55;
      white-space:pre-line;
    }

    /* Admin */
    .admin{
      position:fixed; right:14px; bottom:14px;
      width:min(580px, 92vw);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(10,14,34,.72);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding:12px;
      z-index:9997;
      display:none;
    }
    .admin.show{display:block;}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;}
    button{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
      color: var(--txt);
      padding:10px 12px;
      border-radius: 14px;
      font-size:13px;
      cursor:pointer;
      transition: transform .08s ease, background .12s ease;
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation;
    }
    button:hover{background: rgba(255,255,255,.11); transform: translateY(-1px);}
    .mini{font-size:12px; color:var(--mut); line-height:1.7; white-space:pre-line;}

    @media (max-width:720px){
      .title{font-size:22px}
      .choices{grid-template-columns:1fr}
      .toast{top:9%;}
    }

    /* =========================
       ✅ 手机版新增：触控控制面板（不影响舞台）
       - 右下角小圆点打开
       - 面板可拖动/可收起（简化：只收起）
    ========================= */
    .mctl-fab{
      position:fixed;
      right:14px;
      bottom:14px;
      width:54px;height:54px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(10,14,34,.70);
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10001;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .mctl-fab:active{transform: scale(.98);}
    .mctl-fab span{
      font-weight:1100;
      letter-spacing:.5px;
      color:rgba(238,240,255,.9);
      font-size:14px;
    }

    .mctl{
      position:fixed;
      right:14px;
      bottom:78px;
      width:min(520px, 94vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(10,14,34,.78);
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      padding:12px;
      z-index:10001;
      display:none;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .mctl.show{display:block;}
    .mctl .mrow{display:flex;gap:10px;flex-wrap:wrap;}
    .mctl .mrow + .mrow{margin-top:10px;}
    .mctl .mb{
      flex:1;
      min-width: 120px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(238,240,255,.94);
      font-size:14px;
      font-weight:900;
      letter-spacing:.3px;
      text-align:center;
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation;
    }
    .mctl .mb:active{transform: translateY(1px); background: rgba(255,255,255,.11);}
    .mctl .mb.small{min-width: 92px; flex:0 0 auto;}
    .mctl .mb.warn{border-color: rgba(255,211,107,.28); background: rgba(255,211,107,.10);}
    .mctl .mb.good{border-color: rgba(107,231,168,.28); background: rgba(107,231,168,.10);}
    .mctl .mb.bad{border-color: rgba(255,107,138,.28); background: rgba(255,107,138,.10);}
    .mctl .mtip{
      margin-top:8px;
      font-size:12px;
      color:rgba(238,240,255,.70);
      line-height:1.5;
      white-space:pre-line;
    }
  </style>
</head>

<body>
  <div class="snow" aria-hidden="true"></div>

  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">2026冬日列车</div>
        <div class="sub mono">
          O=普通｜H=隐藏｜Space=结算｜岔路 A/B/C｜W=许愿词｜R=重置
        </div>
      </div>
      <div class="pill"><b>当前待结算</b>：<span id="pendingType">未选择</span></div>
    </div>

    <div class="main">
      <div class="stage">
        <div class="row">
          <div>
            <div class="headline">舞台字幕</div>
            <div class="hint">你拆完后按 <span class="mono">O/H</span> 标记，再按 <span class="mono">Space</span> 结算。</div>
            <div class="metaLine">
              <span class="metaTag"><b id="actTag">幕一 · 起程</b></span>
              <span class="metaTag">许愿：<b id="wishTag">未写入</b></span>
            </div>
          </div>
          <div class="pill"><b>最后播报</b>：<span id="lastEvt" class="mono">-</span></div>
        </div>

        <div class="row">
          <div style="min-width:min(1180px, 95vw);">
            <div id="cardTitle">结果卡：等待结算</div>
            <div id="cardBody">你拆完后按 O（普通）或 H（隐藏），再按 Space 结算。</div>
          </div>
        </div>

        <div class="kpi">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <div class="chip m">最近3条：</div>
            <div class="chip" id="t1">-</div>
            <div class="chip" id="t2">-</div>
            <div class="chip" id="t3">-</div>
          </div>
          <div class="chip m mono"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="t1">
      <div class="tt" id="toastTitle">提示</div>
      <div class="badge warn" id="toastBadge">事件</div>
    </div>
    <div class="msg" id="toastMsg">内容</div>
  </div>

  <!-- 岔路 -->
  <div class="overlay" id="overlay">
    <div class="choiceBox">
      <div class="choiceTop">
        <div class="cTitle" id="choiceTitle">岔路出现：请选择 A / B / C</div>
        <div class="cHint mono">按键：A 或 B 或 C</div>
      </div>
      <div class="choices">
        <div class="opt" id="optA"><div class="letter">A</div><div class="sub">选择后触发事件播报</div></div>
        <div class="opt" id="optB"><div class="letter">B</div><div class="sub">解锁站台灯</div></div>
        <div class="opt" id="optC"><div class="letter">C</div><div class="sub">路线改变</div></div>
      </div>
    </div>
  </div>

  <!-- 站台灯舞台大字 -->
  <div class="lamp" id="lamp">
    <div class="lampCard">
      <div class="lampTitle" id="lampTitle">站台灯亮起</div>
      <div class="lampSub" id="lampSub">回礼车厢开启</div>
    </div>
  </div>

  <!-- Admin（原样保留） -->
  <div class="admin" id="admin">
    <div class="btnRow">
      <button id="btnO">普通（O）</button>
      <button id="btnH">隐藏（H）</button>
      <button id="btnGo">结算（Space）</button>
      <button id="btnR">重置（R）</button>
      <button id="btnS">隐藏面板（S）</button>
    </div>
    <div class="mini mono" id="adminInfo">Admin</div>
  </div>

  <!-- ✅ 手机版触控控制：右下角小圆点 + 面板 -->
  <div class="mctl-fab" id="mFab" aria-label="控制面板"><span>控</span></div>
  <div class="mctl" id="mCtl" aria-hidden="true">
    <div class="mrow">
      <div class="mb good" id="mO">普通 O</div>
      <div class="mb warn" id="mH">隐藏 H</div>
      <div class="mb" id="mGo">结算</div>
    </div>
    <div class="mrow">
      <div class="mb" id="mA">岔路 A</div>
      <div class="mb" id="mB">岔路 B</div>
      <div class="mb" id="mC">岔路 C</div>
    </div>
    <div class="mrow">
      <div class="mb small" id="mW">许愿 W</div>
      <div class="mb small" id="mF">强制加拆 F</div>
      <div class="mb small bad" id="mR">重置 R</div>
      <div class="mb small" id="mS">面板 S</div>
    </div>
    <div class="mtip">提示：手机上用这里操作即可（不需要键盘）</div>
  </div>

<script>
/* =========================
   配置
========================= */
const CFG = {
  common: 519,
  hidden: 11,
  scarf: 12,
  doll: 3,

  branchEvery: 3,
  hiddenAddStreak: 3,

  cAddTotal: 30,
  cUnlockPerB: 1,

  // 三幕主线（每30单推进一幕）
  actStep: 30,
  acts: [
    { name: "幕一 · 起程", cue: "暖灯亮起，风铃响了——列车正式出发。" },
    { name: "幕二 · 暴雪", cue: "窗外暴雪加剧——隐藏车厢与补给开始紧张。" },
    { name: "幕三 · 回家", cue: "远处出现熟悉的灯火——我们正在靠近‘家’。" }
  ],

  // 大礼物解锁节奏（内部队列，不对观众展示库存）
  giftUnlockOrders: [15, 30, 45, 62, 80, 98, 120, 142, 166, 192, 220, 248, 278, 310, 345],
  giftSequence: [
    "围巾","围巾","玲娜贝尔",
    "围巾","围巾","围巾","玲娜贝尔",
    "围巾","围巾","围巾","玲娜贝尔",
    "围巾","围巾","围巾","围巾"
  ],

  finalAnnouncement:
`各位乘客我们的终点站 —— 家 已经到达
请各位收拾好自己的盒子并检查和确认是否有疑问
如有疑问请联系客服为您检查`
};

/* =========================
   文案池
========================= */
const TEXT = {
  base: [
    "列车广播轻响：雪夜在窗外慢慢铺开",
    "车厢灯带亮起：空气里多了一点暖",
    "站台风铃一响：冬天的故事开始推进",
    "玻璃起雾又散：像有人悄悄在守护"
  ],
  hidden: [
    "隐藏车厢被点亮：霜面裂开一道光",
    "站牌翻面：出现一张隐藏车票",
    "铃声轻响：隐藏纪念章落在掌心",
    "车门合上又开：雪景短暂露面"
  ],
  add: [
    "补给车厢接驳：随行礼已装载",
    "暖风机启动：多一份安心被递上",
    "补给箱弹开：额外守护已到账",
    "列车员点头：加挂一节暖车厢"
  ],
  branchA: [
    "岔路转向：车厢里响起轻快旋律",
    "你按下按钮：仪表盘亮起温柔提示",
    "车门一开一合：落下一张回礼卡",
    "灯带变色：弹幕瞬间沸腾"
  ],
  branchB: [
    "转轨成功：引擎低鸣、速度悄悄上来",
    "列车加速：前方车厢出现新灯号",
    "轨道切换：一段新剧情被点亮",
    "提示音响：路线确认、故事推进"
  ],
  branchC: [
    "补给信号闪烁：连接通道开启",
    "接驳完成：后方多出一节小车厢",
    "仪表盘闪了一下：补给已就位",
    "车厢尽头亮灯：补给车靠站"
  ],
  upgrade: [
    "系统提示：补给已满载，回礼升级为纪念款",
    "车厢提示：改为升级回礼（更精致更稀有）",
    "提示音落下：升级回礼已入袋",
    "暖光聚焦：升级回礼作为通关印记"
  ],
  scarf: [
    "围炉小站亮灯：冬日围巾悄悄系上",
    "北风被挡在门外：围巾到位",
    "暖光从车门涌出：围巾作为通关礼",
    "雪花落在肩头：围巾刚好接住"
  ],
  doll: [
    "车厢尽头出现玩偶座：玲娜贝尓入座",
    "小铃铛摇响：玲娜贝尔被送上车",
    "暖灯聚焦：玲娜贝尔成为今晚主角",
    "列车长微笑点头：玲娜贝尔到站"
  ],
  bigGiftCue: [
    "列车提示：B方向车厢亮起金色灯号",
    "广播低声提醒：B方向即将开启补给",
    "车门处出现暖光：B方向似乎更近了",
    "站台灯牌闪烁：B方向正在呼叫"
  ]
};

/* =========================
   工具：洗牌抽文案
========================= */
function shuffle(a){
  a=a.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
const DECK = {}, IDX = {};
function initDecks(){
  for(const k of Object.keys(TEXT)){
    DECK[k]=shuffle(TEXT[k]);
    IDX[k]=0;
  }
}
function pick(k){
  const d=DECK[k]||["…"];
  const i=IDX[k]||0;
  IDX[k]=i+1;
  return d[i % d.length];
}

/* =========================
   状态
========================= */
const S = {
  pendingType: null,
  ended: false,

  commonLeft: CFG.common,
  hiddenLeft: CFG.hidden,
  scarfLeft: CFG.scarf,
  dollLeft: CFG.doll,

  addStreak: 0,
  ordersInternal: 0,
  branchPending: false,

  cTotal: CFG.cAddTotal,
  cUnlocked: 0,
  cUsed: 0,
  cBuffForNext: false,

  giftUnlockIdx: 0,
  pendingGifts: [],

  stationLight: 0,
  act: 1,

  wishText: "未写入",
  wishPendingOnce: false,

  forceAddNext: false,

  ticker: ["-","-","-"],
};

const $ = (id)=>document.getElementById(id);
const overlay = $("overlay");
const toast = $("toast");
const admin = $("admin");
const lamp = $("lamp");

/* =========================
   UI
========================= */
function stamp(){
  const t=new Date();
  return t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
}
function showToast(title,msg,type){
  $("toastTitle").textContent=title;
  $("toastMsg").textContent=msg;
  const b=$("toastBadge");
  b.className="badge "+(type||"warn");
  b.textContent=(type==="good")?"推进":(type==="bad"?"提示":"事件");
  toast.classList.remove("show"); void toast.offsetWidth; toast.classList.add("show");
}
function setEvt(text){ $("lastEvt").textContent=`${text} @ ${stamp()}`; }
function pushTicker(line){
  S.ticker.unshift(line);
  S.ticker=S.ticker.slice(0,3);
  $("t1").textContent=S.ticker[0];
  $("t2").textContent=S.ticker[1];
  $("t3").textContent=S.ticker[2];
}
function renderPending(){
  $("pendingType").textContent = S.pendingType ? (S.pendingType==="H" ? "隐藏" : "普通") : "未选择";
}
function renderAdmin(){
  const cAvail = Math.max(0, S.cUnlocked - S.cUsed);
  $("adminInfo").textContent =
`库存：普通 ${S.commonLeft}｜隐藏 ${S.hiddenLeft}｜围巾 ${S.scarfLeft}｜娃娃 ${S.dollLeft}
隐藏加拆期：${S.addStreak}
C池：总 ${S.cTotal}｜已解锁 ${S.cUnlocked}｜可用 ${cAvail}｜已用 ${S.cUsed}
站台灯：${S.stationLight}
待发放大礼物：${S.pendingGifts.length}
内部单数：${S.ordersInternal}
主线：${CFG.acts[S.act-1].name}
许愿：${S.wishText}（下一单写入：${S.wishPendingOnce ? "ON" : "OFF"}）
强制下一单加拆：${S.forceAddNext ? "ON" : "OFF"}`;
}
function toggleAdmin(){ admin.classList.toggle("show"); renderAdmin(); }

function setActTag(){
  $("actTag").textContent = CFG.acts[S.act-1].name;
}
function setWishTag(){
  $("wishTag").textContent = S.wishText || "未写入";
}

/* ===== 站台灯：舞台级全屏大字 ===== */
function showLamp(title, sub){
  $("lampTitle").textContent = title;
  $("lampSub").textContent = sub;
  lamp.classList.remove("show");
  void lamp.offsetWidth;
  lamp.classList.add("show");
  setTimeout(()=>lamp.classList.remove("show"), 1700);
}

/* =========================
   终点站
========================= */
function hardEndShow(){
  S.ended = true;
  overlay.classList.remove("show");
  S.branchPending = false;
  S.pendingType = null;
  renderPending();

  $("cardTitle").textContent = "终点站广播";
  $("cardBody").textContent = CFG.finalAnnouncement;

  setEvt("终点站已到达");
  pushTicker("已到终点站");
  showToast("终点站", CFG.finalAnnouncement, "good");
  renderAdmin();
}

/* =========================
   主线推进（三幕）
========================= */
function updateAct(){
  const newAct = Math.min(3, 1 + Math.floor(S.ordersInternal / CFG.actStep));
  if (newAct !== S.act){
    S.act = newAct;
    setActTag();
    const a = CFG.acts[S.act - 1];
    showToast("主线推进", `${a.name}\n${a.cue}`, "warn");
    setEvt(`主线推进：${a.name}`);
    pushTicker(`主线：${a.name}`);
  }
}

/* =========================
   许愿词写入（W）
========================= */
function setWish(){
  if (S.ended) return;
  const v = window.prompt("输入许愿词（如：平安/恋爱/发财/回家）：", (S.wishText==="未写入"?"平安":S.wishText));
  if (!v) return;
  S.wishText = v.trim().slice(0,8) || "未写入";
  S.wishPendingOnce = true;
  setWishTag();
  showToast("许愿已写入", `下一单会把「${S.wishText}」写进剧情`, "good");
  setEvt("已写入许愿词");
  renderAdmin();
}

/* =========================
   标记本单类型
========================= */
function setPendingType(t){
  if (S.ended) return;
  S.pendingType=t;
  renderPending();
  showToast("已标记","本单已标记。按 Space 结算。","good");
  setEvt("已标记本单类型");
  renderAdmin();
}

/* =========================
   大礼物解锁队列
========================= */
function maybeUnlockGifts(){
  while (S.giftUnlockIdx < CFG.giftUnlockOrders.length &&
         S.ordersInternal >= CFG.giftUnlockOrders[S.giftUnlockIdx]) {
    S.pendingGifts.push(CFG.giftSequence[S.giftUnlockIdx]);
    S.giftUnlockIdx += 1;
  }
}
function awardBigGift(kind, rewards, events){
  if (kind==="玲娜贝尔"){
    if (S.dollLeft>0){ S.dollLeft-=1; rewards.push("玲娜贝尔"); events.push(pick("doll")); return; }
  } else {
    if (S.scarfLeft>0){ S.scarfLeft-=1; rewards.push("围巾"); events.push(pick("scarf")); return; }
  }
  rewards.push("升级回礼");
  events.push(pick("upgrade"));
}

/* =========================
   站台灯揭晓：下一次任意岔路可亮灯
========================= */
function maybeRevealBigGiftAnyBranch(rewards, events){
  if (S.stationLight > 0 && S.pendingGifts.length > 0){
    S.stationLight -= 1;

    const g = S.pendingGifts[0];
    showLamp("站台灯亮起", `回礼车厢开启\n即将揭晓：${g === "玲娜贝尔" ? "玲娜贝尔" : "围巾"}`);

    events.push("站台灯亮起：回礼车厢开启");

    const real = S.pendingGifts.shift();
    awardBigGift(real, rewards, events);
  }
}

/* =========================
   岔路
========================= */
function maybeTriggerBranch(){
  if (S.ordersInternal>0 && S.ordersInternal % CFG.branchEvery===0){
    S.branchPending=true;
    overlay.classList.add("show");
    $("choiceTitle").textContent="岔路出现：请选择 A / B / C";
    showToast("岔路出现", pick("bigGiftCue"), "warn");
    setEvt("岔路等待选择");
    return true;
  }
  return false;
}

function chooseBranch(letter){
  if (S.ended) return;
  if (!S.branchPending) return;

  S.branchPending=false;
  overlay.classList.remove("show");

  const rewards=[], events=[];
  events.push(letter==="A"?pick("branchA"):letter==="B"?pick("branchB"):pick("branchC"));

  rewards.push("手链");
  events.push(pick("bracelet"));

  if (letter==="A"){
    rewards.push("随行回礼：已到位");
  }

  if (letter==="B"){
    rewards.push("章节推进");
    S.stationLight += 1;
    events.push("站牌闪烁：站台灯已解锁");

    if (S.cUnlocked < S.cTotal){
      S.cUnlocked = Math.min(S.cTotal, S.cUnlocked + CFG.cUnlockPerB);
      rewards.push("补给权限+1");
      events.push("提示音落下：补给权限被点亮");
    }
  }

  if (letter==="C"){
    S.cBuffForNext = true;
    events.push("站台广播：下一单将触发补给");
  }

  maybeRevealBigGiftAnyBranch(rewards, events);

  const evtLine = `触发随机事件：${events[0] || "…"}`;
  const rewardLine = `获得：\n- ${rewards.join("\n- ")}`;

  $("cardTitle").textContent = "岔路结果卡";
  $("cardBody").textContent  = `${evtLine}\n${rewardLine}`;

  pushTicker(`岔路：${letter}`);
  setEvt("岔路已结算");
  renderAdmin();

  const toastType = (rewards.includes("围巾") || rewards.includes("玲娜贝尔")) ? "warn" : "good";
  showToast("岔路播报", `${evtLine}\n${rewardLine}`, toastType);
}

/* =========================
   结算一单
========================= */
function settleOne(){
  if (S.ended) return;

  if (S.branchPending){
    showToast("岔路进行中","先按 A/B/C 完成岔路选择。","bad");
    return;
  }
  if (!S.pendingType){
    showToast("还没标记","先按 O（普通）或 H（隐藏）再结算。","bad");
    return;
  }
  if (S.commonLeft + S.hiddenLeft <= 0){
    hardEndShow();
    return;
  }

  const rewards=[], events=[];
  rewards.push("手链");
  events.push(pick("bracelet"));

  if (S.pendingType==="H"){
    if (S.hiddenLeft>0){
      S.hiddenLeft -= 1;
      S.addStreak = Math.max(S.addStreak, CFG.hiddenAddStreak);
      events.unshift(pick("hidden"));
      rewards.push("隐藏剧情已点亮");
    } else {
      if (S.commonLeft<=0){ hardEndShow(); return; }
      S.commonLeft -= 1;
      events.unshift("系统提示：隐藏已用尽，本次按普通结算");
    }
  } else {
    if (S.commonLeft<=0){ hardEndShow(); return; }
    S.commonLeft -= 1;
    events.unshift(pick("base"));
  }

  if (S.wishPendingOnce && S.wishText && S.wishText!=="未写入"){
    S.wishPendingOnce = false;
    events.splice(1, 0, `许愿车票已盖章：愿你「${S.wishText}」`);
  }

  S.ordersInternal += 1;
  maybeUnlockGifts();
  updateAct();
  setActTag();

  let addPaid = false;
  const cAvail = Math.max(0, S.cUnlocked - S.cUsed);

  if (S.forceAddNext && !addPaid){
    S.forceAddNext = false;
    if (S.commonLeft > 0){
      S.commonLeft -= 1;
      addPaid = true;
      rewards.push("加拆手机壳");
      events.push(pick("add"));
    } else {
      rewards.push("升级回礼");
      events.push(pick("upgrade"));
    }
  }

  if (!addPaid && S.addStreak > 0){
    if (S.commonLeft > 0){
      S.commonLeft -= 1;
      addPaid = true;
      rewards.push("加拆手机壳");
      events.push(pick("add"));
    } else {
      rewards.push("升级回礼");
      events.push(pick("upgrade"));
    }
    S.addStreak -= 1;
    S.cBuffForNext = false;
  }

  if (!addPaid && S.cBuffForNext){
    if (cAvail > 0 && S.commonLeft > 0){
      S.commonLeft -= 1;
      S.cUsed += 1;
      addPaid = true;
      rewards.push("加拆手机壳");
      events.push(pick("add"));
    } else {
      rewards.push("升级回礼");
      events.push(pick("upgrade"));
    }
    S.cBuffForNext = false;
  }

  const evtLine = `触发随机事件：${events[0] || "…"}`;
  const displayRewards = addPaid ? rewards.filter(r => r !== "手链") : rewards;
  const rewardLine = `获得：${displayRewards.join(" + ")}`;
  const addLine = addPaid ? "加拆：已兑现（额外+1壳）" : "";

  $("cardTitle").textContent = "结果卡：已结算";
  $("cardBody").textContent  = addPaid
    ? `${evtLine}\n${rewardLine}\n${addLine}`
    : `${evtLine}\n${rewardLine}`;

  const toastType = (displayRewards.includes("加拆手机壳") || displayRewards.includes("围巾") || displayRewards.includes("娃娃")) ? "warn" : "good";
  showToast("本单播报", addPaid ? `${evtLine}\n${rewardLine}\n${addLine}` : `${evtLine}\n${rewardLine}`, toastType);

  pushTicker(addPaid ? "本单：加拆已兑现" : "本单：已结算");
  setEvt("本单已结算");
  renderAdmin();

  S.pendingType = null;
  renderPending();

  if (S.commonLeft + S.hiddenLeft <= 0){
    hardEndShow();
    return;
  }

  maybeTriggerBranch();
}

/* =========================
   重置
========================= */
function resetAll(){
  initDecks();

  S.pendingType = null;
  S.ended = false;

  S.commonLeft = CFG.common;
  S.hiddenLeft = CFG.hidden;
  S.scarfLeft  = CFG.scarf;
  S.dollLeft   = CFG.doll;

  S.addStreak = 0;
  S.ordersInternal = 0;
  S.branchPending = false;

  S.cTotal = CFG.cAddTotal;
  S.cUnlocked = 0;
  S.cUsed = 0;
  S.cBuffForNext = false;

  S.giftUnlockIdx = 0;
  S.pendingGifts = [];

  S.stationLight = 0;

  S.act = 1;
  setActTag();

  S.wishText = "未写入";
  S.wishPendingOnce = false;
  setWishTag();

  S.forceAddNext = false;

  S.ticker = ["-","-","-"];
  $("t1").textContent="-"; $("t2").textContent="-"; $("t3").textContent="-";

  overlay.classList.remove("show");

  $("cardTitle").textContent = "结果卡：等待结算";
  $("cardBody").textContent  = "你拆完后按 O（普通）或 H（隐藏），再按 Space 结算。";
  $("lastEvt").textContent   = "-";

  renderPending();
  renderAdmin();

  showToast("已重置","O=普通｜H=隐藏｜Space=结算｜岔路 A/B/C｜W=许愿词写入","warn");
}

/* =========================
   绑定按钮（原样）
========================= */
$("btnO").onclick=()=>setPendingType("O");
$("btnH").onclick=()=>setPendingType("H");
$("btnGo").onclick=()=>settleOne();
$("btnR").onclick=()=>resetAll();
$("btnS").onclick=()=>toggleAdmin();

/* =========================
   键盘控制（原样）
========================= */
window.addEventListener("keydown",(e)=>{
  if (e.code==="Space") e.preventDefault();
  const k = e.key.toLowerCase();

  if (k==="o"){ setPendingType("O"); return; }
  if (k==="h"){ setPendingType("H"); return; }
  if (e.code==="Space"){ settleOne(); return; }

  if (k==="a"){ chooseBranch("A"); return; }
  if (k==="b"){ chooseBranch("B"); return; }
  if (k==="c"){ chooseBranch("C"); return; }

  if (k==="f"){
    if (!S.ended) S.forceAddNext = true;
    renderAdmin();
    return;
  }

  if (k==="w"){
    setWish();
    return;
  }

  if (k==="s"){ toggleAdmin(); return; }
  if (k==="r"){ resetAll(); return; }
});

/* =========================
   ✅ 手机版触控：绑定同样函数
========================= */
const mFab = $("mFab");
const mCtl = $("mCtl");
mFab.addEventListener("click", ()=> {
  mCtl.classList.toggle("show");
  mCtl.setAttribute("aria-hidden", mCtl.classList.contains("show") ? "false" : "true");
});
$("mO").addEventListener("click", ()=>setPendingType("O"));
$("mH").addEventListener("click", ()=>setPendingType("H"));
$("mGo").addEventListener("click", ()=>settleOne());
$("mA").addEventListener("click", ()=>chooseBranch("A"));
$("mB").addEventListener("click", ()=>chooseBranch("B"));
$("mC").addEventListener("click", ()=>chooseBranch("C"));
$("mW").addEventListener("click", ()=>setWish());
$("mF").addEventListener("click", ()=>{
  if (!S.ended) S.forceAddNext = true;
  renderAdmin();
  // 不给观众提示，只给你一个非常轻的触觉反馈（如果支持）
  try { navigator.vibrate && navigator.vibrate(20); } catch(e){}
});
$("mR").addEventListener("click", ()=>resetAll());
$("mS").addEventListener("click", ()=>toggleAdmin());

// ✅ overlay 的 A/B/C 也可点
$("optA").addEventListener("click", ()=>chooseBranch("A"));
$("optB").addEventListener("click", ()=>chooseBranch("B"));
$("optC").addEventListener("click", ()=>chooseBranch("C"));

initDecks();
resetAll();
</script>
</body>
</html>
